<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>
      <ion-icon name="gameController" class="title-icon"></ion-icon>
      {{ 'APP.TITLE' | translate }}
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="selectLanguage()">
        <span class="lang-flag">{{ getCurrentLanguageFlag() }}</span>
      </ion-button>
      <ion-button (click)="logout()">
        <ion-icon name="logOut" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Connection Status Card -->
  <ion-card class="status-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon [name]="isConnected() ? 'bluetooth' : 'bluetoothOutline'" 
                  [class.connected]="isConnected()"></ion-icon>
        {{ 'BLUETOOTH.STATUS' | translate }}
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (isConnected()) {
        <div class="connection-status connected">
          <ion-icon name="checkmarkCircle" color="success"></ion-icon>
          <span>{{ 'BLUETOOTH.CONNECTED' | translate }} <strong>{{ getConnectedDevice()?.name || ('BLUETOOTH.UNKNOWN_DEVICE' | translate) }}</strong></span>
        </div>
        <ion-button expand="block" color="danger" (click)="disconnect()">
          <ion-icon name="closeCircle" slot="start"></ion-icon>
          {{ 'BLUETOOTH.DISCONNECT' | translate }}
        </ion-button>
      } @else {
        <div class="connection-status disconnected">
          <ion-icon name="closeCircle" color="medium"></ion-icon>
          <span>{{ 'BLUETOOTH.NOT_CONNECTED' | translate }}</span>
        </div>
        <ion-button expand="block" (click)="startScan()" [disabled]="isScanning">
          @if (isScanning) {
            <ion-spinner name="crescent" slot="start"></ion-spinner>
            {{ 'BLUETOOTH.SCANNING' | translate }}
          } @else {
            <ion-icon name="search" slot="start"></ion-icon>
            {{ 'BLUETOOTH.SCAN_FOR_DEVICE' | translate }}
          }
        </ion-button>
        @if (isScanning) {
          <ion-button expand="block" color="medium" fill="outline" (click)="stopScan()">
            {{ 'BLUETOOTH.STOP_SCAN' | translate }}
          </ion-button>
        }
      }
    </ion-card-content>
  </ion-card>

  <!-- Discovered Devices -->
  @if (discoveredDevices.length > 0 && !isConnected()) {
    <ion-card class="devices-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="bluetooth"></ion-icon>
          {{ 'BLUETOOTH.DISCOVERED_DEVICES' | translate }}
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="full">
          @for (device of discoveredDevices; track device.deviceId) {
            <ion-item button (click)="connectToDevice(device)" [disabled]="isConnecting">
              <ion-icon name="bluetooth" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h2>{{ device.name || ('BLUETOOTH.UNKNOWN_DEVICE' | translate) }}</h2>
                <p class="device-id">{{ device.deviceId }}</p>
              </ion-label>
              @if (isConnecting) {
                <ion-spinner name="crescent" slot="end"></ion-spinner>
              } @else {
                <ion-badge slot="end" color="primary">{{ 'BLUETOOTH.CONNECT' | translate }}</ion-badge>
              }
            </ion-item>
          }
        </ion-list>
      </ion-card-content>
    </ion-card>
  }

  <!-- Button Press Log -->
  @if (isConnected()) {
    <ion-card class="log-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="flash"></ion-icon>
          {{ 'LOG.TITLE' | translate }}
          <ion-chip color="success" class="log-count">
            {{ buttonPressLog.length }}
          </ion-chip>
        </ion-card-title>
        <ion-button fill="clear" size="small" (click)="clearLog()">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-card-header>
      <ion-card-content>
        @if (buttonPressLog.length === 0) {
          <div class="empty-log">
            <ion-icon name="flash" color="medium"></ion-icon>
            <p>{{ 'LOG.EMPTY' | translate }}</p>
            <p class="hint">{{ 'LOG.HINT' | translate }}</p>
          </div>
        } @else {
          <ion-list lines="full" class="log-list">
            @for (event of buttonPressLog; track event.timestamp.getTime()) {
              <ion-item class="log-item">
                <div class="log-icon" slot="start">
                  <ion-icon name="flash" color="warning"></ion-icon>
                </div>
                <ion-label>
                  <h3 class="log-button-id">{{ 'LOG.BUTTON' | translate }} {{ event.buttonId }}</h3>
                  <p class="log-time">{{ formatTime(event.timestamp) }}</p>
                </ion-label>
                <ion-badge slot="end" color="tertiary">{{ event.data }}</ion-badge>
              </ion-item>
            }
          </ion-list>
        }
      </ion-card-content>
    </ion-card>
  }

  <!-- Help Card when not connected and no devices -->
  @if (!isConnected() && discoveredDevices.length === 0 && !isScanning) {
    <ion-card class="help-card">
      <ion-card-content>
        <div class="help-content">
          <ion-icon name="bluetooth" class="help-icon"></ion-icon>
          <h2>{{ 'HELP.TITLE' | translate }}</h2>
          <p>1. {{ 'HELP.STEP_1' | translate }}</p>
          <p>2. {{ 'HELP.STEP_2' | translate }}</p>
          <p>3. {{ 'HELP.STEP_3' | translate }}</p>
          <p>4. {{ 'HELP.STEP_4' | translate }}</p>
        </div>
      </ion-card-content>
    </ion-card>
  }
</ion-content>
